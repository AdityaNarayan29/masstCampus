# Nginx configuration for multi-tenant custom domains
# This config handles:
# 1. Multiple custom domains pointing to the same Next.js app
# 2. Preserving the original Host header via X-Forwarded-Host
# 3. SSL termination (when using Let's Encrypt)

# Upstream backend servers
upstream nextjs_frontend {
    server frontend:3000;
    # For Vercel deployment, use Vercel URL instead:
    # server your-app.vercel.app:443;
}

upstream nestjs_backend {
    server backend:3001;
}

# HTTP to HTTPS redirect (for production)
# server {
#     listen 80;
#     server_name *.yourdomain.com yourdomain.com;
#     return 301 https://$host$request_uri;
# }

# Main server block - handles all custom domains
server {
    listen 80;
    # listen 443 ssl http2; # Uncomment for SSL

    # Wildcard domain to catch all subdomains + custom domains
    server_name
        portal.vidyamandir.com
        vidyamandir.edu
        portal.vidyamandir.local
        *.school-crm.com
        localhost;

    # SSL certificates (Let's Encrypt)
    # ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;

    # Access and error logs
    access_log /var/log/nginx/school-crm-access.log;
    error_log /var/log/nginx/school-crm-error.log;

    # Max upload size
    client_max_body_size 10M;

    # Frontend - Next.js
    location / {
        proxy_pass http://nextjs_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # CRITICAL: Preserve original host for tenant resolution
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;

        # Optional: Add tenant ID if you've pre-resolved it
        # proxy_set_header X-Tenant-ID $tenant_id;
    }

    # Backend API - NestJS
    location /api/ {
        proxy_pass http://nestjs_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;

        # CRITICAL: Preserve original host for tenant resolution
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# Example: Specific domain with custom configuration
# server {
#     listen 443 ssl http2;
#     server_name portal.vidyamandir.com;
#
#     ssl_certificate /etc/letsencrypt/live/portal.vidyamandir.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/portal.vidyamandir.com/privkey.pem;
#
#     location / {
#         proxy_pass http://nextjs_frontend;
#         proxy_set_header X-Forwarded-Host $host;
#         proxy_set_header Host $host;
#     }
# }
